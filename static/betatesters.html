<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>BetGame beta testers</title>
		<script src="/scripts/jquery-1.11.3.min.js"></script>
		<script src="/scripts/common.js"></script>
		<script>
$(function() {
	function showUsers() {
		API.call('GET', 'betatesters', {}, function(ret) {
			$('#login_form').slideUp();
			var games = {};
			var csv = '';
			var flagvals = {
				'medium': ['email', 'skype', 'xbox'],
				'flags': ['contacted', 'got_reply'],
			};
			$.each(ret.betatesters, function(i, tester) {
				// prepare statistics
				$.each(tester.gametypes, function(i, game) {
					games[game] = (games[game] || 0) + 1;
				});

				var row = $('<tr/>');
				$.each(['id', 'email', 'name', 'gametypes', 'platforms', 'console', 'create_date',
						'medium', 'flags',
				], function(i, k) {
					var v = tester[k];
					if(flagvals[k]) {
						vals = $.unique($.merge($.merge([], v), flagvals[k]));
						var td = $('<td/>');
						$.each(vals, function(k, prop) {
							var cbox = $('<input/>', {
								'type': 'checkbox',
								'data-uid': tester['id'],
								'data-key': k,
								'name': prop,
								'class': 'flagtoggle',
							});
							if(v.indexOf(prop) >= 0)
								cbox.attr('checked', 1);
							$('<label/>')
								.append(cbox)
								.append(prop)
								.appendTo(td);
						});
						td.appendTo(row);
					} else if(Array.isArray(v) && v.length && v[0]) {
						var child = $('<ul/>');
						$.each(v, function(i, point) {
							$('<li/>', {text: point}).appendTo(child);
						});
						$('<td/>').append(child).appendTo(row);
					} else {
						if(v !== 0 && (!v || (typeof v == 'object' && !v.length)))
							v = '(none)';
						$('<td/>', {text: String(v)}).appendTo(row);
					}
				});
				$('#users').append(row);

				csv += $.map([
						'name', '', 'email', '', '',
						'From Web form', ''
				], function(key) {
					if(key === '')
						return key;
					if(typeof tester[key] === 'undefined')
						return key;
					return tester[key];
				}).join(',') + '\n';
			});
			$('#users').slideDown();
			$('#export').attr('href', 'data:attachment/csv,'+encodeURIComponent(csv)).slideDown();

			// now handle statistics
			var sortable = [];
			for(game in games) {
				sortable.push([game, games[game]]);
			}
			sortable.sort(function(a,b) {
				return b[1] - a[1]; // reversed sort
			});
			$.each(sortable, function(i, elem) {
				var row = $('<tr/>');
				$('<td/>').text(elem[0]).appendTo(row);
				$('<td/>').text(elem[1]).appendTo(row);
				$('#gamestats').append(row);
			});
			$('#gamestats').slideDown();
		}, function(err) {
			$('#message').text(JSON.stringify(err));
		});
	}
	$('#users').on('change', 'input.flagtoggle', function(e) {
		var cb = this,
			uid = $(this).data('uid'),
			key = $(this).data('key'),
			val = [],
			state = this.checked;
		$(this).parents('td').find('input').each(function() {
			val.push($(this).attr('name'));
		});
		API.call('PATCH', 'beta/'+uid, {
			key: val.join(','),
		}, function(ret) {
			console.info('success');
		}, function(err) {
			cb.checked = !cb.checked;
		});
	});
	$('#login_form').submit(function(e) {
		e.preventDefault();

		$('#login_submit').remove();
		var form = $('#login_form'),
			data = {
				id: form.find('#name').val(),
				password: form.find('#password').val(),
			};
		API.call('POST', 'players/_/login', data, function(ret) {
			API.token = ret.token;
			showUsers();
		}, function(err) {
			form.find('#message').text(JSON.stringify(err));
		});
	});
});
		</script>
	</head>
	<body>
		<h1>BetGame beta testers</h1>
		<form id="login_form" action="">
			<div>
				You should login as admin in order to continue!
			</div>
			<input type="text" id="name" placeholder="Your email or userid"/>
			<input type="password" id="password" placeholder="Password?"/>
			<input id="login_submit" type="submit" value="OK"/>
			<div id="message" style="color: red;"></div>
		</form>
		<a id="export" target="_blank" download="beta-testers.csv" style="display: none;">Export to CSV</a>
		<a href="#gamestats">Go to game stats</a>
		<table id="users" style="display: none;" border="1">
			<tr>
				<th>ID</th>
				<th>E-mail</th>
				<th>Name</th>
				<th>Game types</th>
				<th>Platforms</th>
				<th>Consoles</th>
				<th>Create date</th>
				<th>Medium</th>
				<th>Flags</th>
			</tr>
		</table>
		<table id="gamestats" style="display: none;" border="1">
			<tr>
				<th>Game</th>
				<th>Count</th>
			</tr>
		</table>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65612741-1', 'auto');
    ga('send', 'pageview');

</script>
	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>BetGame Password Recovery</title>
		<script src="/scripts/jquery-1.11.3.min.js"></script>
		<script>
function parseHash() {
	var obj = {};
	$.each(window.location.hash.substr(1).split('&'), function(i,pair) {
		var key, val;
		var idx = pair.indexOf('=');
		if(idx >= 0) {
			key = pair.substr(0, idx);
			val = pair.substr(idx+1);
		} else {
			key = pair;
			val = '';
		}
		obj[key.toLowerCase()] = val;
	});
	return obj;
}
var hash = parseHash();

$(function() {
	// load user info
	$.ajax({
		dataType: 'json',
		url: '/v1/players/'+hash.userid,
		success: function(player) {
			$('#gamertag').text(player.player_nick || '<unknown>');
			$('#email').text(player.email || '<unknown>');
		},
	});

	$('#pw_form').submit(function(e) {
		e.preventDefault();

		var pass = $('#password').val(),
			pass2 = $('#password2').val();
		if(pass != pass2) {
			$('#password2').focus();
			$('#message').text('Passwords don\'t match');
			return;
		}

		$.ajax({
			dataType: 'json',
			method: 'PATCH',
			url: '/v1/players/'+hash.userid,
			data: {
				password: pass,
			},
			complete: function(xhr, stat) {
				var ret = xhr.responseJSON;
				if(xhr.status == 200) {
					$('#pw_form').slideUp(); // hide
					$('#success').slideDown(); // show
				} else {
					$('#message').text('Couldn\'t update password: ' +
							(ret.error || ('Unknown error '+xhr.status)));
				}
			},
		});
	});
});
		</script>
	</head>
	<body>
		<h1>BetGame Password Recovery</h1>
		<form id="pw_form" action="">
			<div>
				Player with gamertag <span id="gamertag"></span> and email <span id="email"></span>
				requested password recovery.
			</div>
			<div>
				Please enter your new password below:
			</div>
			<input type="password" id="password" placeholder="Enter new password"/>
			<input type="password" id="password2" placeholder="Confirm your password"/>
			<div id="message" style="color: red;"></div>
			<input type="submit" value="OK"/>
		</form>
		<div id="success" style="display: none;">
			Your password is now updated.
		</div>
	</body>
</html>
